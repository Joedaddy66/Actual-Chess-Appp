name: Security Audit & Dependency Check
on: 
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run security audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate || (echo "❌ Security vulnerabilities found!" && exit 1)
          
      - name: Check for deprecated 'request' package
        run: |
          echo "Checking for deprecated 'request' package..."
          if npm ls request --all 2>/dev/null | grep -q "request@"; then 
            echo "❌ Deprecated 'request' package found in dependencies!" 
            npm ls request --all
            exit 1
          else
            echo "✅ No deprecated 'request' package found"
          fi
          
      - name: Check for vulnerable form-data versions
        run: |
          echo "Checking for vulnerable form-data versions..."
          if npm ls form-data --all 2>/dev/null | grep -q "form-data@2\.3\."; then 
            echo "❌ Vulnerable form-data@2.3.x found!" 
            npm ls form-data --all
            exit 1
          else
            echo "✅ No vulnerable form-data versions found"
          fi
          
      - name: Verify clean dependency tree
        run: |
          echo "Final verification of dependency tree..."
          echo "Current dependencies:"
          npm ls --depth=0
          echo "✅ Security checks passed!"

  build-test:
    runs-on: ubuntu-latest
    needs: security-audit
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build application
        run: npm run build
        
      - name: Verify build artifacts
        run: |
          echo "Checking build artifacts..."
          if [ -d "dist" ]; then
            echo "✅ Build successful - dist folder created"
            ls -la dist/
          else
            echo "❌ Build failed - no dist folder found"
            exit 1
          fi
